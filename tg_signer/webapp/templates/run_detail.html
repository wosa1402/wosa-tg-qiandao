{% extends "base.html" %}
{% set show_nav = true %}
{% set title = "è¿è¡Œè¯¦æƒ… - TG Signer Web" %}

{% block content %}
  <div class="card">
    <div class="card-header">
      <div class="card-title">ğŸ“Œ è¿è¡Œè¯¦æƒ…</div>
      <div class="btn-group">
        <a class="btn btn-secondary btn-sm" href="/runs">è¿”å›</a>
        {% if run.status == "running" %}
          <form method="post" action="/runs/{{ run.run_id }}/stop" style="display: inline;">
            <input type="hidden" name="csrf_token" value="{{ csrf_token }}" />
            <button class="btn btn-danger btn-sm" type="submit">åœæ­¢</button>
          </form>
        {% endif %}
      </div>
    </div>

    <div class="card-body">
      <div class="table-container">
        <table class="table">
          <thead>
            <tr>
              <th>run_id</th>
              <th>ä»»åŠ¡</th>
              <th>è´¦å·</th>
              <th>æ¨¡å¼</th>
              <th>çŠ¶æ€</th>
              <th>å¼€å§‹</th>
              <th>ç»“æŸ</th>
              <th>exit_code</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><code>{{ run.run_id }}</code></td>
              <td>{{ run.task_name }}</td>
              <td>{{ run.account_name }}</td>
              <td class="text-secondary">{{ run.mode }}</td>
              <td>
                {% if run.status == "running" %}
                  <span class="badge badge-info">è¿è¡Œä¸­</span>
                {% elif run.status == "success" %}
                  <span class="badge badge-success">æˆåŠŸ</span>
                {% elif run.status == "failed" %}
                  <span class="badge badge-danger">å¤±è´¥</span>
                {% elif run.status == "stopped" %}
                  <span class="badge badge-muted">å·²åœæ­¢</span>
                {% elif run.status == "stopping" %}
                  <span class="badge badge-warning">åœæ­¢ä¸­</span>
                {% else %}
                  <span class="badge badge-muted">{{ run.status }}</span>
                {% endif %}
              </td>
              <td class="text-secondary" style="font-size: 12px;">{{ run.started_at or "-" }}</td>
              <td class="text-secondary" style="font-size: 12px;">{{ run.finished_at or "-" }}</td>
              <td class="text-secondary" style="font-size: 12px;">{{ run.exit_code if run.exit_code is not none else "-" }}</td>
            </tr>
          </tbody>
        </table>
      </div>

      {% if run.error_message %}
        <div class="alert alert-danger" style="margin-top: var(--spacing-md);">{{ run.error_message }}</div>
      {% endif %}
    </div>

    <div class="card-footer">
      <div class="text-secondary">æ—¥å¿—ï¼šå®æ—¶åˆ·æ–°ï¼ˆSSEï¼‰</div>
      <div class="btn-group">
        <button class="btn btn-ghost btn-sm" type="button" onclick="scrollLogsBottom()">â¬‡ï¸ æ»šåŠ¨åˆ°åº•éƒ¨</button>
      </div>
    </div>

    <div class="card-body" style="padding-top: 0;">
      <pre id="logs" class="log-container"></pre>
    </div>
  </div>

  <script>
    (function () {
      const logs = document.getElementById("logs");
      function append(line) {
        logs.textContent += line + "\\n";
        logs.scrollTop = logs.scrollHeight;
      }

      window.scrollLogsBottom = function () {
        logs.scrollTop = logs.scrollHeight;
      }

      const es = new EventSource("/runs/{{ run.run_id }}/logs/stream");
      es.addEventListener("log", (e) => append(e.data));
      es.addEventListener("status", (e) => append("[status] " + e.data));
      es.addEventListener("ping", () => {});
      es.onerror = () => {
        append("[warn] æ—¥å¿—è¿æ¥ä¸­æ–­ï¼Œæµè§ˆå™¨å°†è‡ªåŠ¨é‡è¯•...");
      };
    })();
  </script>
{% endblock %}
