{% extends "base.html" %}
{% set show_nav = true %}
{% set title = "ä»»åŠ¡å‘å¯¼ - TG Signer Web" %}

{% block content %}
  <div class="panel" style="max-width: 980px;">
    <div class="row">
      <h2 style="margin: 0;">ä»»åŠ¡å‘å¯¼ï¼š<code>{{ task.task_name }}</code></h2>
      <div style="display: flex; gap: 10px; flex-wrap: wrap;">
        <a class="btn" href="/tasks">è¿”å›ä»»åŠ¡åˆ—è¡¨</a>
        <a class="btn" href="/tasks/{{ task.task_name }}/edit">æ”¹ç”¨ JSON ç¼–è¾‘</a>
      </div>
    </div>
    <p class="muted">
      ç”¨è¡¨å•ç”Ÿæˆå¹¶ä¿å­˜ <code>config.json</code>ã€‚å½“å‰ä»…æ”¯æŒâ€œç­¾åˆ°ä»»åŠ¡ï¼ˆsignerï¼‰â€ã€‚
      ç”Ÿæˆåä¾ç„¶å¯ä»¥å›åˆ° JSON é¡µé¢åšé«˜çº§ä¿®æ”¹ã€‚
    </p>
    {% if ok %}
      <p class="ok">å·²ç”Ÿæˆå¹¶ä¿å­˜é…ç½®</p>
    {% endif %}
    {% if errors %}
      <div class="error">
        {% for err in errors %}
          <div>{{ err }}</div>
        {% endfor %}
      </div>
    {% endif %}

    <form method="post" action="/tasks/{{ task.task_name }}/wizard">
      <input type="hidden" name="csrf_token" value="{{ csrf_token }}" />

      <h3 style="margin-top: 6px;">1) é€‰æ‹©å¯¹è¯ï¼ˆchat_idï¼‰</h3>

      <div class="field">
        <label>ä»æœ€è¿‘å¯¹è¯é€‰æ‹©ï¼ˆå¯é€‰ï¼‰</label>
        <select id="recent_chat_select" style="padding: 10px 12px; border-radius: 10px; border: 1px solid var(--border); background: rgba(0,0,0,0.18); color: var(--text);">
          <option value="">ï¼ˆä¸é€‰æ‹©ï¼Œæ‰‹åŠ¨å¡«å†™ï¼‰</option>
          {% for c in recent_chats %}
            <option value="{{ c.id }}">{{ c.label }}</option>
          {% endfor %}
        </select>
        <div class="muted">å¦‚æœåˆ—è¡¨ä¸ºç©ºï¼Œè¯·å…ˆåœ¨ /accounts ç™»å½• Telegram è´¦å·ã€‚</div>
      </div>

      <div class="field">
        <label>chat_idï¼ˆå¿…å¡«ï¼‰</label>
        <input id="chat_id_input" type="text" name="chat_id" placeholder="ä¾‹å¦‚ -1001234567890" value="{{ (form.chat_id if form else '') }}" required />
        <div class="muted">ç¾¤/é¢‘é“é€šå¸¸ä¸ºè´Ÿæ•°ï¼›ä¹Ÿå¯ä»¥ç›´æ¥å¡«ä»æœºå™¨äººè¾“å‡ºé‡Œçœ‹åˆ°çš„ chat idã€‚</div>
      </div>

      <div class="field">
        <label>å¯¹è¯å¤‡æ³¨åï¼ˆå¯é€‰ï¼‰</label>
        <input type="text" name="chat_name" placeholder="ä¾‹å¦‚ æ¯æ—¥ç­¾åˆ°æœºå™¨äºº" value="{{ (form.chat_name if form else '') }}" />
      </div>

      <div class="field">
        <label>å‘é€æ¶ˆæ¯åç­‰å¾… N ç§’åˆ é™¤ï¼ˆå¯é€‰ï¼‰</label>
        <input type="text" name="delete_after" placeholder="ä¾‹å¦‚ 10ï¼›ç•™ç©ºè¡¨ç¤ºä¸åˆ é™¤" value="{{ (form.delete_after if form else '') }}" />
      </div>

      <div class="field">
        <label>åŠ¨ä½œé—´éš”ï¼ˆç§’ï¼‰</label>
        <input type="text" name="action_interval" value="{{ (form.action_interval if form else '1') }}" />
      </div>

      <h3 style="margin-top: 18px;">2) é…ç½®åŠ¨ä½œæµï¼ˆactionsï¼‰</h3>
      <p class="muted">ç¬¬ 1 ä¸ªåŠ¨ä½œå¿…é¡»æ˜¯â€œå‘é€æ–‡æœ¬â€æˆ–â€œå‘é€éª°å­â€ã€‚ç©ºè¡Œä¼šè¢«å¿½ç•¥ã€‚</p>

      <div class="panel" style="padding: 12px;">
        <table style="width: 100%; border-collapse: collapse;">
          <thead>
            <tr style="text-align: left;">
              <th style="padding: 10px; border-bottom: 1px solid var(--border); width: 90px;">åºå·</th>
              <th style="padding: 10px; border-bottom: 1px solid var(--border); width: 260px;">åŠ¨ä½œç±»å‹</th>
              <th style="padding: 10px; border-bottom: 1px solid var(--border);">å‚æ•°ï¼ˆæŒ‰ç±»å‹å¡«å†™ï¼‰</th>
            </tr>
          </thead>
          <tbody>
            {% for i in [1,2,3,4,5,6] %}
              <tr>
                <td style="padding: 10px; border-bottom: 1px solid var(--border);"><span class="muted">ç¬¬ {{ i }} ä¸ª</span></td>
                <td style="padding: 10px; border-bottom: 1px solid var(--border);">
                  <select name="action_{{ i }}_type" style="width: 100%; padding: 10px 12px; border-radius: 10px; border: 1px solid var(--border); background: rgba(0,0,0,0.18); color: var(--text);">
                    <option value="">ï¼ˆç©ºï¼‰</option>
                    <option value="send_text" {% if form and form["action_" ~ i ~ "_type"] == "send_text" %}selected{% endif %}>å‘é€æ–‡æœ¬</option>
                    <option value="send_dice" {% if form and form["action_" ~ i ~ "_type"] == "send_dice" %}selected{% endif %}>å‘é€éª°å­</option>
                    <option value="click_text" {% if form and form["action_" ~ i ~ "_type"] == "click_text" %}selected{% endif %}>æ ¹æ®æ–‡æœ¬ç‚¹å‡»é”®ç›˜</option>
                    <option value="choose_image" {% if form and form["action_" ~ i ~ "_type"] == "choose_image" %}selected{% endif %}>æ ¹æ®å›¾ç‰‡é€‰æ‹©é€‰é¡¹ï¼ˆéœ€å¤§æ¨¡å‹ï¼‰</option>
                    <option value="reply_calc" {% if form and form["action_" ~ i ~ "_type"] == "reply_calc" %}selected{% endif %}>å›å¤è®¡ç®—é¢˜ï¼ˆéœ€å¤§æ¨¡å‹ï¼‰</option>
                  </select>
                </td>
                <td style="padding: 10px; border-bottom: 1px solid var(--border);">
                  <input type="text" name="action_{{ i }}_value" placeholder="å‘é€æ–‡æœ¬/æŒ‰é’®æ–‡æœ¬/éª°å­(é»˜è®¤ğŸ²)" value="{{ (form["action_" ~ i ~ "_value"] if form else '') }}" />
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <h3 style="margin-top: 18px;">3) è¿è¡Œè®¡åˆ’ï¼ˆsign_atï¼‰</h3>
      <div class="field">
        <label>æ¯æ—¥æ—¶é—´ï¼ˆæ¨èï¼‰</label>
        <input id="sign_at_time" type="time" value="" />
        <div class="muted">é€‰æ‹©åä¼šè‡ªåŠ¨å¡«å……ä¸‹é¢çš„è¾“å…¥æ¡†ï¼ˆç”Ÿæˆ crontabï¼‰ã€‚</div>
      </div>
      <div class="field">
        <label>é«˜çº§ï¼štime æˆ– crontab</label>
        <input id="sign_at_input" type="text" name="sign_at" placeholder="ä¾‹å¦‚ 06:00 æˆ– 0 6 * * *" value="{{ (form.sign_at if form else '0 6 * * *') }}" />
        <div class="muted">æ”¯æŒ HH:MM / HH:MM:SSï¼Œä¹Ÿæ”¯æŒ crontab è¡¨è¾¾å¼ã€‚</div>
      </div>
      <div class="field">
        <label>ç­¾åˆ°æ—¶é—´éšæœºè¯¯å·®ï¼ˆç§’ï¼‰</label>
        <input type="text" name="random_seconds" value="{{ (form.random_seconds if form else '300') }}" />
      </div>
      <div class="field">
        <label>å¤š chat è¿ç»­ç­¾åˆ°é—´éš”ï¼ˆç§’ï¼‰</label>
        <input type="text" name="sign_interval" value="{{ (form.sign_interval if form else '1') }}" />
      </div>

      <button class="btn primary" type="submit">ç”Ÿæˆå¹¶ä¿å­˜</button>
    </form>

    {% if preview %}
      <div style="height: 16px;"></div>
      <h3 style="margin-top: 0;">ç”Ÿæˆé¢„è§ˆ</h3>
      <div class="field">
        <textarea rows="18" style="width: 100%; padding: 12px; border-radius: 10px; border: 1px solid var(--border); background: rgba(0,0,0,0.18); color: var(--text); font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace;" readonly>{{ preview }}</textarea>
      </div>
    {% endif %}
  </div>

  <script>
    (function () {
      const select = document.getElementById("recent_chat_select");
      const input = document.getElementById("chat_id_input");
      if (!select || !input) return;
      select.addEventListener("change", function () {
        if (select.value) input.value = select.value;
      });
    })();

    (function () {
      const timeInput = document.getElementById("sign_at_time");
      const cronInput = document.getElementById("sign_at_input");
      if (!timeInput || !cronInput) return;

      function cronToTime(value) {
        const raw = (value || "").trim();
        const timeMatch = raw.match(/^(\d{1,2}):(\d{2})(?::\d{2})?$/);
        if (timeMatch) {
          const hour = parseInt(timeMatch[1], 10);
          const minute = parseInt(timeMatch[2], 10);
          if (isNaN(hour) || isNaN(minute)) return null;
          if (hour < 0 || hour > 23 || minute < 0 || minute > 59) return null;
          return String(hour).padStart(2, "0") + ":" + String(minute).padStart(2, "0");
        }
        const parts = raw.split(/\s+/);
        if (parts.length !== 5) return null;
        if (parts[2] !== "*" || parts[3] !== "*" || parts[4] !== "*") return null;
        const minute = parseInt(parts[0], 10);
        const hour = parseInt(parts[1], 10);
        if (isNaN(hour) || isNaN(minute)) return null;
        if (hour < 0 || hour > 23 || minute < 0 || minute > 59) return null;
        return String(hour).padStart(2, "0") + ":" + String(minute).padStart(2, "0");
      }

      function timeToCron(value) {
        const raw = (value || "").trim();
        if (!raw) return "";
        const parts = raw.split(":");
        if (parts.length < 2) return "";
        const hour = parseInt(parts[0], 10);
        const minute = parseInt(parts[1], 10);
        if (isNaN(hour) || isNaN(minute)) return "";
        if (hour < 0 || hour > 23 || minute < 0 || minute > 59) return "";
        return `${minute} ${hour} * * *`;
      }

      const initial = cronToTime(cronInput.value);
      if (initial) timeInput.value = initial;

      timeInput.addEventListener("input", function () {
        const cron = timeToCron(timeInput.value);
        if (cron) cronInput.value = cron;
      });

      cronInput.addEventListener("input", function () {
        const t = cronToTime(cronInput.value);
        if (t) timeInput.value = t;
      });
    })();
  </script>
{% endblock %}
