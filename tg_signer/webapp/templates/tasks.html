{% extends "base.html" %}
{% set show_nav = true %}
{% set title = "ä»»åŠ¡ - TG Signer Web" %}

{% block content %}
  <p class="text-secondary mb-md">
    â€œå¯ç”¨â€è¡¨ç¤ºè¯¥ä»»åŠ¡ä¼šæŒ‰ <code>sign_at</code> çš„è®¡åˆ’è¿è¡Œï¼›â€œè¿è¡Œä¸€æ¬¡â€ä¼šç«‹åˆ»æ‰§è¡Œä¸€æ¬¡ï¼ˆä¸å½±å“å¯ç”¨çŠ¶æ€ï¼‰ã€‚
  </p>

  {% if ok %}
    <div class="alert alert-success">{{ ok }}</div>
  {% endif %}
  {% if error %}
    <div class="alert alert-danger">{{ error }}</div>
  {% endif %}

  <div class="card mb-lg">
    <div class="card-header">
      <div class="card-title">â• åˆ›å»ºæ–°ä»»åŠ¡</div>
      <a class="btn btn-secondary btn-sm" href="/accounts">è´¦å·ç®¡ç†</a>
    </div>
    <div class="card-body">
      <form method="post" action="/tasks">
        <input type="hidden" name="csrf_token" value="{{ csrf_token }}" />
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">ä»»åŠ¡åç§°</label>
            <input class="form-input" type="text" name="task_name" placeholder="ä¾‹å¦‚ï¼šæ¯æ—¥ç­¾åˆ°" value="{{ (form.task_name if form else '') }}" required />
          </div>
          <div class="form-group">
            <label class="form-label">é€‰æ‹©è´¦å·</label>
            <select class="form-select" name="account_name" required>
              {% if accounts|length == 0 %}
                <option value="">è¯·å…ˆåˆ›å»ºè´¦å·</option>
              {% else %}
                {% for a in accounts %}
                  <option value="{{ a }}" {% if form and form.account_name == a %}selected{% endif %}>{{ a }}</option>
                {% endfor %}
              {% endif %}
            </select>
          </div>
        </div>
        <div class="btn-group">
          {% if accounts|length == 0 %}
            <button class="btn btn-primary" type="submit" disabled>åˆ›å»ºä»»åŠ¡</button>
            <span class="text-muted">å…ˆå» /accounts åˆ›å»ºå¹¶ç™»å½•è´¦å·</span>
          {% else %}
            <button class="btn btn-primary" type="submit">åˆ›å»ºä»»åŠ¡</button>
          {% endif %}
        </div>
      </form>
    </div>
  </div>

  {% if tasks|length == 0 %}
    <div class="empty-state">
      <div class="empty-state-icon">ğŸ“‹</div>
      <div class="empty-state-title">æš‚æ— ä»»åŠ¡</div>
      <div class="empty-state-text">å…ˆåˆ›å»ºä»»åŠ¡ï¼Œå†è¿›å…¥é…ç½®é¡µé¢ç¼–è¾‘ JSON æˆ–ä½¿ç”¨å‘å¯¼é…ç½®ã€‚</div>
    </div>
  {% else %}
    <div class="mb-lg">
      {% for t in tasks %}
        <div class="task-card mb-md">
          <div class="task-card-header">
            <div class="task-card-title">
              {% if not t.config_ok %}
                <span class="status-dot error"></span>
              {% elif t.running %}
                <span class="status-dot online"></span>
              {% elif t.enabled and not t.logged_in %}
                <span class="status-dot warning"></span>
              {% elif t.enabled %}
                <span class="status-dot online"></span>
              {% else %}
                <span class="status-dot offline"></span>
              {% endif %}
              {{ t.task_name }}
            </div>
            <div class="flex gap-sm items-center">
              <span class="badge badge-info">{{ t.account_name }}</span>
              {% if not t.config_ok %}
                <span class="badge badge-danger">é…ç½®æœ‰è¯¯</span>
              {% elif t.enabled %}
                {% if t.running %}
                  <span class="badge badge-info">è¿è¡Œä¸­</span>
                {% elif not t.logged_in %}
                  <span class="badge badge-warning">å¾…ç™»å½•</span>
                {% else %}
                  <span class="badge badge-success">å·²å¯ç”¨</span>
                {% endif %}
              {% else %}
                <span class="badge badge-muted">æœªå¯ç”¨</span>
              {% endif %}
            </div>
          </div>

          <div class="task-card-body">
            <div class="task-info-grid">
              <div class="task-info-item">
                <span class="task-info-label">æ‰§è¡Œæ—¶é—´</span>
                <span class="task-info-value">{{ t.schedule_label if t.config_ok else "é…ç½®æœ‰è¯¯" }}</span>
              </div>
              <div class="task-info-item">
                <span class="task-info-label">éšæœºå»¶è¿Ÿ</span>
                <span class="task-info-value">{{ t.random_seconds if t.config_ok else "-" }} ç§’</span>
              </div>
              <div class="task-info-item">
                <span class="task-info-label">è¿ç»­é—´éš”</span>
                <span class="task-info-value">{{ t.sign_interval if t.config_ok else "-" }} ç§’</span>
              </div>
              <div class="task-info-item">
                <span class="task-info-label">æ›´æ–°æ—¶é—´</span>
                <span class="task-info-value">{{ t.updated_at }}</span>
              </div>
            </div>
            {% if t.enabled and not t.logged_in %}
              <div class="text-muted" style="margin-top: var(--spacing-md); font-size: 12px;">
                è¯¥è´¦å·æœªç™»å½• Telegramï¼Œä»»åŠ¡æš‚æ— æ³•æ‰§è¡Œï¼›è¯·å…ˆå» /accounts å®Œæˆç™»å½•ã€‚
              </div>
            {% endif %}
          </div>

          <div class="task-card-footer">
            <div class="btn-group">
              <a class="btn btn-secondary btn-sm" href="/tasks/{{ t.task_name }}/wizard">å‘å¯¼é…ç½®</a>
              <a class="btn btn-secondary btn-sm" href="/tasks/{{ t.task_name }}/edit">JSON ç¼–è¾‘</a>
              <a class="btn btn-secondary btn-sm" href="/tasks/{{ t.task_name }}/schedule">æ—¶é—´è®¾ç½®</a>
              {% if t.running and t.running_run_id %}
                <a class="btn btn-secondary btn-sm" href="/runs/{{ t.running_run_id }}">æŸ¥çœ‹è¿è¡Œ</a>
              {% endif %}
            </div>

            <div class="btn-group">
              <form method="post" action="/tasks/{{ t.task_name }}/run-once" style="display: inline;">
                <input type="hidden" name="csrf_token" value="{{ csrf_token }}" />
                <button class="btn btn-primary btn-sm" type="submit" {% if not t.logged_in %}disabled{% endif %}>è¿è¡Œä¸€æ¬¡</button>
              </form>

              {% if t.enabled %}
                <form method="post" action="/tasks/{{ t.task_name }}/disable" style="display: inline;">
                  <input type="hidden" name="csrf_token" value="{{ csrf_token }}" />
                  <button class="btn btn-danger btn-sm" type="submit">åœç”¨</button>
                </form>
              {% else %}
                <form method="post" action="/tasks/{{ t.task_name }}/enable" style="display: inline;">
                  <input type="hidden" name="csrf_token" value="{{ csrf_token }}" />
                  <button class="btn btn-success btn-sm" type="submit">å¯ç”¨</button>
                </form>
              {% endif %}

              <form method="post" action="/tasks/{{ t.task_name }}/delete" style="display: inline;">
                <input type="hidden" name="csrf_token" value="{{ csrf_token }}" />
                <button class="btn btn-danger btn-sm" type="submit">åˆ é™¤</button>
              </form>
            </div>
          </div>
        </div>
      {% endfor %}
    </div>
  {% endif %}
{% endblock %}
